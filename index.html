<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo Ascent</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #00ffff; overflow-x: hidden; }
        .container { max-width: 100vw; margin: 0 auto; padding: 10px; }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: block; }
        .btn { background: linear-gradient(45deg, #2a2a2a, #1a1a1a); border: 2px solid #00ffff; color: #00ffff; padding: 10px 15px; margin: 5px; cursor: pointer; text-transform: uppercase; transition: all 0.3s; border-radius: 5px; }
        .btn:hover { box-shadow: 0 0 20px #00ffff; transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .nav { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .nav-col { display: flex; flex-direction: column; gap: 5px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: #ffffff; text-shadow: 0 0 10px #00ffff; font-size: 2em; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; background: #1a1a1a; border: 2px solid #00ffff; padding: 15px; border-radius: 10px; margin: 10px 0; }
        .stat { text-align: center; }
        .stat-name { color: #ffffff; font-weight: bold; }
        .stat-value { font-size: 1.5em; color: #00ffff; }
        .tasks { background: #1a1a1a; border: 2px solid #00ffff; padding: 15px; border-radius: 10px; margin: 10px 0; }
        .task { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: #2a2a2a; border-radius: 5px; }
        .task.completed { background: #001a1a; border-left: 4px solid #00ffff; }
        .dungeons-btn { background: linear-gradient(45deg, #2a2a2a, #1a1a1a); border: 2px solid #00ffff; color: #00ffff; font-size: 1.2em; padding: 20px; margin: 20px 0; }
        .player-status { background: #1a1a1a; border: 2px solid #00ffff; padding: 15px; border-radius: 10px; margin: 10px 0; }
        .hp-bar, .xp-bar { width: 100%; height: 20px; background: #2a2a2a; border-radius: 10px; overflow: hidden; margin: 5px 0; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #00ffff, #ffffff); transition: width 0.3s; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #00ffff, #ffffff); transition: width 0.3s; }
        .grid { display: grid; gap: 10px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .card { background: #1a1a1a; border: 2px solid #2a2a2a; padding: 15px; border-radius: 10px; }
        .card:hover { border-color: #00ffff; }
        .combat { text-align: center; background: #1a1a1a; border: 2px solid #00ffff; padding: 20px; border-radius: 10px; position: relative; }
        .damage-log { position: absolute; left: 50%; top: 100%; transform: translateX(-50%); z-index: 999; margin-top: 5px; }
        .player-damage-log { position: absolute; left: 50%; top: 100%; transform: translateX(-50%); z-index: 999; margin-top: 5px; }
        .damage-log-text { background: #ff4444; border: 2px solid #ffffff; color: #ffffff; padding: 10px 15px; border-radius: 5px; font-size: 16px; font-weight: bold; white-space: nowrap; box-shadow: 0 0 10px rgba(255,68,68,0.8); }
        .damage-log-arrow { color: #00ffff; font-size: 18px; margin-left: 5px; }
        .capture-container { text-align: center; max-width: 500px; margin: 0 auto; padding: 20px; }
        .capture-header h1 { color: #ffd700; margin-bottom: 10px; }
        .capture-animation { margin: 30px 0; }
        .boss-icon { font-size: 80px; margin-bottom: 20px; }
        .capture-circle { width: 200px; height: 200px; border: 3px solid #00ffff; border-radius: 50%; margin: 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .capture-text { color: #00ffff; font-size: 16px; margin-bottom: 10px; }
        .capture-progress { width: 80%; height: 10px; background: #2a2a2a; border-radius: 5px; overflow: hidden; }
        .capture-progress::after { content: ''; display: block; height: 100%; background: linear-gradient(90deg, #00ffff, #ffffff); width: 0%; animation: captureProgress 3s ease-in-out forwards; }
        @keyframes captureProgress { 0% { width: 0%; } 100% { width: 100%; } }
        .capture-controls { margin: 20px 0; }
        .capture-go-btn { background: #00ffff; color: #000000; padding: 10px 30px; font-size: 18px; font-weight: bold; }
        .capture-result h2 { color: #00ff00; margin: 20px 0 10px; }
        .capture-result h2.failed { color: #ff4444; }
        .victory-rewards { background: #1a1a1a; border: 2px solid #00ffff; padding: 15px; margin: 20px 0; border-radius: 10px; }
        .rarity-E { color: #ffffff; }
        .rarity-D { color: #00ff00; }
        .rarity-C { color: #0080ff; }
        .rarity-B { color: #8000ff; }
        .rarity-A { color: #ff8000; }
        .rarity-S { color: #ff0080; text-shadow: 0 0 10px #ff0080; }
        .item-description { color: #cccccc; font-size: 0.9em; margin: 5px 0; }
        .item-stats { color: #00ffff; font-size: 0.9em; margin: 5px 0; }
        .item-drops { background: #1a1a1a; border: 2px solid #00ff00; padding: 15px; margin: 10px 0; border-radius: 10px; }
        .item-drop { background: #2a2a2a; padding: 8px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #00ff00; }
        .enemy { font-size: 4em; margin: 20px 0; }
        .turn-indicator { font-size: 1.2em; font-weight: bold; margin: 10px 0; }
        .turn-player { color: #00ffff; }
        .turn-enemy { color: #ffffff; }
        .workout-prompt { background: #2a2a2a; border: 2px solid #00ffff; padding: 20px; margin: 20px 0; border-radius: 10px; }
        .inventory-layout { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; align-items: start; }
        .body-icon { font-size: 6em; text-align: center; }
        .equipment-slots { display: flex; flex-direction: column; gap: 10px; }
        .shop-section { margin: 20px 0; padding: 15px; background: #1a1a1a; border: 2px solid #00ffff; border-radius: 10px; }
        .music-controls { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
        .volume-slider { width: 100%; margin: 10px 0; }
        
        /* Settings Screen Styles */
        .settings-nav { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .settings-nav-btn { background: transparent; border: 2px solid #00ffff; color: #00ffff; padding: 8px 16px; cursor: pointer; text-transform: lowercase; }
        .settings-nav-btn:hover { background: #00ffff; color: #000000; }
        .settings-title { font-size: 1.5em; color: #ffffff; }
        
        .settings-container { display: flex; flex-direction: column; gap: 20px; max-width: 600px; margin: 0 auto; }
        
        .settings-box { 
            background: transparent; 
            border: 2px solid #00ffff; 
            padding: 20px; 
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .settings-box-title { 
            color: #ffffff; 
            font-size: 1.1em; 
            margin-bottom: 10px; 
            text-transform: lowercase;
        }
        
        .settings-option { 
            color: #00ffff; 
            margin: 5px 0; 
            cursor: pointer;
            text-transform: lowercase;
        }
        
        .settings-option:hover { color: #ffffff; }
        
        .settings-controls { margin-top: 15px; }
        
        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            color: #00ffff;
        }
        
        .setting-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #00ffff;
        }
        
        .difficulty-select {
            background: #1a1a1a;
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 8px 12px;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .difficulty-info {
            color: #ffffff;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .split-options {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .split-btn {
            background: transparent;
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 6px 12px;
            cursor: pointer;
            text-transform: lowercase;
            font-size: 0.9em;
        }
        
        .split-btn.active {
            background: #00ffff;
            color: #000000;
        }
        
        .split-btn:hover {
            background: #00ffff;
            color: #000000;
        }
        
        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .volume-range {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #00ffff;
            height: 6px;
        }
        
        .volume-range::-webkit-slider-thumb {
            background: #00ffff;
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        #volumeDisplay {
            color: #00ffff;
            min-width: 40px;
            text-align: right;
        }
        
        .volume-presets {
            display: flex;
            gap: 6px;
        }
        
        .preset-btn {
            background: transparent;
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8em;
            text-transform: lowercase;
        }
        
        .preset-btn:hover {
            background: #00ffff;
            color: #000000;
        }
        
        /* Chest styles */
        .chest-card {
            background: #1a1a1a;
            border: 2px solid #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            position: relative;
        }
        
        .chest-card.opening {
            border-color: #ffaa00;
            box-shadow: 0 0 15px rgba(255, 170, 0, 0.3);
        }
        
        .chest-card.ready {
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .chest-icon {
            font-size: 3em;
            margin: 10px 0;
        }
        
        .chest-timer {
            color: #ffaa00;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .reward-item {
            background: #2a2a2a;
            border: 1px solid #00ffff;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }
        
        .reward-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .settings-btn {
            background: transparent;
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 8px 16px;
            cursor: pointer;
            text-transform: lowercase;
        }
        
        .settings-btn:hover {
            background: #00ffff;
            color: #000000;
        }
        
        .tasks-box {
            min-height: 200px;
            align-items: stretch;
        }
        
        /* Mission Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #1a1a1a;
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .modal-title {
            color: #00ffff;
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        
        .mission-info {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .mission-info h3 {
            color: #00ffff;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .mission-details p {
            margin: 10px 0;
            color: #ffffff;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
        
        .modal-btn {
            background: linear-gradient(45deg, #2a2a2a, #1a1a1a);
            border: 2px solid #00ffff;
            color: #00ffff;
            padding: 12px 25px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .modal-btn:hover {
            box-shadow: 0 0 15px #00ffff;
            transform: translateY(-2px);
        }
        
        .modal-btn.confirm {
            background: linear-gradient(45deg, #00ffff, #ffffff);
            color: #000000;
            font-weight: bold;
        }
        
        .modal-btn.cancel {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            border-color: #ff4444;
            color: #ffffff;
        }
        
        /* In-Game Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            pointer-events: none;
        }
        
        .notification {
            background: linear-gradient(45deg, #1a1a1a, #2a2a2a);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            color: #ffffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            transform: translateX(350px);
            transition: all 0.3s ease-in-out;
            pointer-events: auto;
            min-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        .notification.error {
            border-color: #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }
        
        .notification.warning {
            border-color: #ffaa00;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3);
        }
        
        .notification-icon {
            font-size: 1.2em;
            margin-right: 10px;
        }
        
        .notification-text {
            display: inline-block;
            vertical-align: middle;
        }
        
        .settings-tasks {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
        }
        
        .settings-task {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 3px;
            text-align: left;
        }
        
        .settings-task.completed {
            background: #001a1a;
            border-color: #00ffff;
        }
        
        .settings-task-btn {
            background: transparent;
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .settings-task-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .settings-claim-btn {
            background: linear-gradient(45deg, #00ffff, #ffffff);
            border: 2px solid #00ffff;
            color: #000000;
            padding: 12px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .inventory-layout { grid-template-columns: 1fr; }
            .nav { flex-direction: column; gap: 10px; }
            .nav-col { flex-direction: row; flex-wrap: wrap; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="login" class="screen active">
            <div class="header">
                <h1>üó°Ô∏è SOLO ASCENT üó°Ô∏è</h1>
                <p>Enter your warrior name</p>
            </div>
            <input type="text" id="nickname" placeholder="Warrior Name" style="width: 100%; padding: 15px; font-size: 1.2em; background: #1a1a1a; border: 2px solid #00ffff; color: #00ffff; border-radius: 5px; margin: 20px 0;">
            <button class="btn" onclick="login()" style="width: 100%; padding: 20px; font-size: 1.2em;">üöÄ BEGIN ASCENT</button>
        </div>
        
        <!-- Preferences Setup Screen -->
        <div id="preferences" class="screen">
            <div class="header">
                <h1>‚öôÔ∏è CUSTOMIZE YOUR JOURNEY</h1>
                <p>Tell us about your fitness goals to personalize your experience</p>
            </div>
            
            <div class="settings-container">
                <div class="settings-box">
                    <div class="settings-box-title">gym experience level</div>
                    <div class="settings-controls">
                        <select id="gymLevelSetup" class="difficulty-select">
                            <option value="beginner">beginner - new to fitness</option>
                            <option value="intermediate" selected>intermediate - some experience</option>
                            <option value="advanced">advanced - experienced athlete</option>
                        </select>
                        <div class="difficulty-info">
                            <span id="gymLevelDesc">moderate intensity workouts</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-box">
                    <div class="settings-box-title">preferred workout split</div>
                    <div class="settings-controls">
                        <div class="split-options">
                            <button class="split-btn active" onclick="selectSetupSplit('full-body')">full body</button>
                            <button class="split-btn" onclick="selectSetupSplit('upper-lower')">upper/lower</button>
                            <button class="split-btn" onclick="selectSetupSplit('push-pull')">push/pull/legs</button>
                        </div>
                        <div class="difficulty-info">
                            <span id="splitDesc">work entire body each session</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-box">
                    <div class="settings-box-title">preferred activities</div>
                    <div class="settings-group">
                        <label class="setting-item">
                            <span>bodyweight exercises</span>
                            <input type="checkbox" id="bodyweightSetup" checked>
                        </label>
                        <label class="setting-item">
                            <span>cardio workouts</span>
                            <input type="checkbox" id="cardioSetup">
                        </label>
                        <label class="setting-item">
                            <span>strength training</span>
                            <input type="checkbox" id="strengthSetup">
                        </label>
                        <label class="setting-item">
                            <span>flexibility/yoga</span>
                            <input type="checkbox" id="flexibilitySetup">
                        </label>
                    </div>
                </div>
                
                <div class="settings-box">
                    <div class="settings-box-title">daily wellness goals</div>
                    <div class="settings-group">
                        <label class="setting-item">
                            <span>üíß track water intake</span>
                            <input type="checkbox" id="waterSetup" checked>
                        </label>
                        <label class="setting-item">
                            <span>üö∂ step counting</span>
                            <input type="checkbox" id="stepsSetup">
                        </label>
                        <label class="setting-item">
                            <span>üßò meditation/mindfulness</span>
                            <input type="checkbox" id="meditationSetup">
                        </label>
                        <label class="setting-item">
                            <span>ü§∏ daily stretching</span>
                            <input type="checkbox" id="stretchingSetup" checked>
                        </label>
                    </div>
                </div>
                
                <div class="settings-box">
                    <div class="settings-box-title">fitness goals</div>
                    <div class="settings-group">
                        <label class="setting-item">
                            <span>general fitness</span>
                            <input type="checkbox" id="generalFitnessSetup" checked>
                        </label>
                        <label class="setting-item">
                            <span>weight loss</span>
                            <input type="checkbox" id="weightLossSetup">
                        </label>
                        <label class="setting-item">
                            <span>muscle building</span>
                            <input type="checkbox" id="muscleBuildingSetup">
                        </label>
                        <label class="setting-item">
                            <span>endurance improvement</span>
                            <input type="checkbox" id="enduranceSetup">
                        </label>
                    </div>
                </div>
                
                <div class="settings-box">
                    <div class="settings-box-title">rest day schedule</div>
                    <div class="settings-controls">
                        <label class="setting-item">
                            <span>enable mandatory rest days</span>
                            <input type="checkbox" id="restDaysSetup" checked>
                        </label>
                        <select id="restFrequencySetup" class="difficulty-select" style="margin-top: 10px;">
                            <option value="weekly">weekly rest day</option>
                            <option value="every-other-day">every other day</option>
                        </select>
                        <select id="restDayOfWeekSetup" class="difficulty-select" style="margin-top: 5px;">
                            <option value="sunday" selected>Sunday</option>
                            <option value="monday">Monday</option>
                            <option value="tuesday">Tuesday</option>
                            <option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option>
                            <option value="friday">Friday</option>
                            <option value="saturday">Saturday</option>
                        </select>
                        <div class="difficulty-info" style="margin-top: 10px;">
                            <span id="restDayDesc">Sunday will be your weekly rest day</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="btn" onclick="savePreferencesAndStart()" style="width: 100%; padding: 20px; font-size: 1.2em; margin-top: 20px; background: linear-gradient(45deg, #00ffff, #ffffff); color: #000000;">‚ú® START MY JOURNEY</button>
            <button class="btn" onclick="skipPreferences()" style="width: 100%; padding: 10px; font-size: 1em; margin-top: 10px;">skip for now</button>
        </div>

        <!-- Home Screen -->
        <div id="home" class="screen">
            <div class="nav">
                <div class="nav-col">
                    <button class="btn" onclick="showScreen('profile')">üë§ Profile</button>
                    <button class="btn" onclick="showScreen('shop')">üõí Shop</button>
                    <button class="btn" onclick="showScreen('settings')">‚öôÔ∏è Settings</button>
                </div>
                <div class="nav-col">
                    <button class="btn" onclick="showScreen('inventory')">üéí Inventory</button>
                    <button class="btn" onclick="showScreen('chests')">üì¶ Chests</button>
                    <button class="btn" onclick="showScreen('summoning')">üë• Party</button>
                    <button class="btn" onclick="showScreen('music')">üéµ Music</button>
                </div>
            </div>

            <div class="header">
                <h1 id="playerName">Warrior</h1>
                <p>üí∞ <span id="playerCoins">0</span> coins</p>
            </div>

            <div class="tasks">
                <h2 style="color: #00ffff; margin-bottom: 15px;">üìã DAILY TASKS</h2>
                <div id="taskList"></div>
                <button id="claimBtn" class="btn" onclick="claimRewards()" style="width: 100%; background: linear-gradient(45deg, #00ffff, #ffffff); border-color: #00ffff; color: #000000; display: none;">üéÅ CLAIM ALL REWARDS</button>
            </div>

            <button class="btn dungeons-btn" onclick="showScreen('dungeons')" style="width: 100%;">‚öîÔ∏è ENTER DUNGEONS</button>
            
            <div id="scavengeInfo" class="card" style="display: none; margin: 10px 0;">
                <h3>üîç Scavenge Mode</h3>
                <p>Collect loot from each monster defeated. Get all scavenged loot when completing or running from dungeon.</p>
                <div id="scavengedLootSummary" style="margin-top: 10px;"></div>
            </div>

            <div class="stats-grid">
                <div class="stat"><div class="stat-name">STR</div><div class="stat-value" id="strValue">1</div><button class="btn" onclick="assignStat('str')">+</button></div>
                <div class="stat"><div class="stat-name">AGI</div><div class="stat-value" id="agiValue">1</div><button class="btn" onclick="assignStat('agi')">+</button></div>
                <div class="stat"><div class="stat-name">VIT</div><div class="stat-value" id="vitValue">1</div><button class="btn" onclick="assignStat('vit')">+</button></div>
                <div class="stat"><div class="stat-name">INT</div><div class="stat-value" id="intValue">1</div><button class="btn" onclick="assignStat('int')">+</button></div>
                <div class="stat"><div class="stat-name">PER</div><div class="stat-value" id="perValue">1</div><button class="btn" onclick="assignStat('per')">+</button></div>
            </div>
            <p style="text-align: center; color: #ffffff;">Unspent Points: <span id="unspentPoints">0</span></p>

            <div class="player-status">
                <p>Level <span id="playerLevel">1</span></p>
                <div class="xp-bar"><div class="xp-fill" id="xpFill"></div></div>
                <p>HP: <span id="playerHp">100</span>/<span id="playerMaxHp">100</span></p>
                <div class="hp-bar"><div class="hp-fill" id="hpFill"></div></div>
            </div>
        </div>

        <!-- Dungeons Screen -->
        <div id="dungeons" class="screen">
            <button class="btn" onclick="showScreen('home')">üè† Home</button>
            <div class="header"><h1>‚öîÔ∏è DUNGEONS</h1></div>
            <div id="dungeonList" class="grid"></div>
        </div>

        <!-- Combat Screen -->
        <div id="combat" class="screen">
            <div class="combat">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div style="position: relative;">
                        <span id="playerNameCombat">Player</span><br>HP: <span id="playerHpCombat">0</span>/<span id="playerMaxHpCombat">0</span>
                        <div id="playerDamageLog" class="player-damage-log" style="display: none;">
                            <div class="damage-log-text">-<span id="playerDamageLogAmount">90</span></div>
                        </div>
                    </div>
                    <div style="position: relative;">
                        <span id="enemyNameCombat">Enemy</span><br>HP: <span id="enemyHpCombat">0</span>/<span id="enemyMaxHpCombat">0</span>
                        <div id="damageLog" class="damage-log" style="display: none;">
                            <div class="damage-log-text">-<span id="damageLogAmount">90</span></div>
                        </div>
                    </div>
                </div>
                <div class="enemy" id="enemyIcon">üßô‚Äç‚ôÇÔ∏è</div>
                <div class="turn-indicator" id="turnIndicator">Your Turn</div>
                <div id="workoutPrompt" class="workout-prompt" style="display: none;">
                    <h3 id="workoutText">10 Push-ups</h3>
                    <button class="btn" onclick="confirmWorkout()">‚úÖ DONE</button>
                    <button class="btn" onclick="cancelWorkout()">‚ùå CANCEL</button>
                </div>
                <div id="combatActions">
                    <button class="btn" id="attackBtn" onclick="attack()">‚öîÔ∏è ATTACK</button>
                    <button class="btn" id="itemBtn" onclick="showCombatItems()">üß™ ITEM</button>
                    <button class="btn" id="runBtn" onclick="runAway()">üèÉ RUN</button>
                    <button class="btn" id="scavengeBtn" onclick="toggleScavenge()">üîç SCAVENGE</button>
                </div>
            </div>
        </div>

        <!-- Combat Items Screen -->
        <div id="combatItems" class="screen">
            <button class="btn" onclick="showScreen('combat')">üîô Back to Combat</button>
            <div class="header"><h1>üß™ COMBAT ITEMS</h1></div>
            <div id="combatItemGrid" class="grid grid-3"></div>
        </div>

        <!-- Boss Capture Screen -->
        <div id="capture" class="screen">
            <div class="capture-container">
                <div class="capture-header">
                    <h1>üèÜ VICTORY!</h1>
                    <p>You defeated the boss!</p>
                </div>
                
                <div class="capture-animation">
                    <div class="boss-icon" id="captureBossIcon">üëπ</div>
                    <div class="capture-circle" id="captureCircle" style="display: none;">
                        <div class="capture-text" id="captureText">Attempting Capture...</div>
                        <div class="capture-progress" id="captureProgress"></div>
                    </div>
                </div>
                
                <div class="capture-controls" id="captureControls">
                    <p>Capture chance: <span id="captureChance">85%</span></p>
                    <button class="btn capture-go-btn" onclick="attemptCapture()">GO</button>
                </div>
                
                <div class="capture-result" id="captureResult" style="display: none;">
                    <h2 id="captureResultText">Success!</h2>
                    <p id="captureResultDesc">Boss captured!</p>
                </div>
                
                <div class="victory-rewards">
                    <h3>Rewards:</h3>
                    <p>‚≠ê XP: <span id="victoryXP">0</span></p>
                    <p>üí∞ Coins: <span id="victoryCoins">0</span></p>
                </div>
                
                <div id="itemDropsSection" class="item-drops" style="display: none;">
                    <h3>üéÅ Item Drops:</h3>
                    <div id="itemDropsList"></div>
                </div>
                
                <button class="btn" id="captureCloseBtn" onclick="closeCaptureScreen()" style="display: none;">Continue</button>
            </div>
        </div>

        <!-- Inventory Screen -->
        <div id="inventory" class="screen">
            <button class="btn" onclick="showScreen('home')">üè† Home</button>
            <div class="header"><h1>üéí INVENTORY</h1></div>
            <div class="inventory-layout">
                <div class="equipment-slots">
                    <div class="card" id="armorSlots">
                        <h3>Armor</h3>
                        <div>üõ°Ô∏è Helmet: <span id="helmet">None</span></div>
                        <div>üëï Chest: <span id="chest">None</span></div>
                        <div>üëñ Legs: <span id="legs">None</span></div>
                        <div>üëû Boots: <span id="boots">None</span></div>
                    </div>
                </div>
                <div>
                    <div class="body-icon">üßô‚Äç‚ôÇÔ∏è</div>
                    <div class="card" style="text-align: center;">
                        <div>‚öîÔ∏è Weapon: <span id="weapon">None</span></div>
                    </div>
                </div>
                <div class="equipment-slots">
                    <div class="card" id="accessorySlots">
                        <h3>Accessories</h3>
                        <div>üíç Ring 1: <span id="ring1">None</span></div>
                        <div>üíç Ring 2: <span id="ring2">None</span></div>
                        <div>üìø Necklace: <span id="necklace">None</span></div>
                        <div>‚åö Bracelet: <span id="bracelet">None</span></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>Sorting</h3>
                <div class="grid-4">
                    <button class="btn" onclick="filterItems('all')">All</button>
                    <button class="btn" onclick="filterItems('weapons')">Weapons</button>
                    <button class="btn" onclick="filterItems('armor')">Armor</button>
                    <button class="btn" onclick="filterItems('accessories')">Accessories</button>
                </div>
            </div>
            <div id="itemGrid" class="grid grid-3"></div>
        </div>

        <!-- Shop Screen -->
        <div id="shop" class="screen">
            <button class="btn" onclick="showScreen('home')">üè† Home</button>
            <div class="header"><h1>üõí DAILY SHOP</h1></div>
            <div id="shopItems"></div>
        </div>

        <!-- Music Screen -->
        <div id="music" class="screen">
            <button class="btn" onclick="showScreen('home')">üè† Home</button>
            <div class="header"><h1>üéµ MUSIC</h1></div>
            <div class="grid grid-2">
                <button class="btn" onclick="addSong()">‚ûï Add Song</button>
                <button class="btn" onclick="deleteSong()">üóëÔ∏è Delete Song</button>
                <button class="btn" id="shuffleBtn" onclick="toggleShuffle()">üîÄ Shuffle</button>
                <button class="btn" id="loopBtn" onclick="toggleLoop()">üîÅ Loop</button>
            </div>
            <div class="card">
                <h3>Now Playing</h3>
                <p id="currentSong">No song selected</p>
                <div class="music-controls">
                    <button class="btn" onclick="previousSong()">‚èÆÔ∏è</button>
                    <button class="btn" id="playBtn" onclick="togglePlay()">‚ñ∂Ô∏è</button>
                    <button class="btn" onclick="nextSong()">‚è≠Ô∏è</button>
                </div>
                <div>Progress: <span id="progress">0%</span></div>
                <div>üîä Volume: <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50"></div>
            </div>
            <div class="card">
                <h3>Playlist</h3>
                <div id="playlist"></div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profile" class="screen">
            <button class="btn" onclick="showScreen('home')">üè† Home</button>
            <div class="header"><h1>üë§ PROFILE</h1></div>
            
            <div class="card">
                <h2 id="profileName">Warrior</h2>
                <div class="grid grid-2">
                    <div>Level: <span id="profileLevel">1</span></div>
                    <div>XP: <span id="profileXP">0</span></div>
                    <div>Coins: <span id="profileCoins">0</span></div>
                    <div>Total Dungeons: <span id="profileDungeons">0</span></div>
                </div>
            </div>
            
            <div class="card">
                <h3>Character Stats</h3>
                <div class="stats-grid">
                    <div class="stat"><div class="stat-name">STR</div><div class="stat-value" id="profileStr">1</div></div>
                    <div class="stat"><div class="stat-name">AGI</div><div class="stat-value" id="profileAgi">1</div></div>
                    <div class="stat"><div class="stat-name">VIT</div><div class="stat-value" id="profileVit">1</div></div>
                    <div class="stat"><div class="stat-name">INT</div><div class="stat-value" id="profileInt">1</div></div>
                    <div class="stat"><div class="stat-name">PER</div><div class="stat-value" id="profilePer">1</div></div>
                </div>
            </div>
            
            <div class="card">
                <h3>Friends (<span id="friendCount">0</span>)</h3>
                <div class="grid grid-2">
                    <button class="btn" onclick="addFriend()">‚ûï Add Friend</button>
                    <button class="btn" onclick="removeFriend()">‚ûñ Remove Friend</button>
                </div>
                <div id="friendsList"></div>
            </div>
            
            <div class="card">
                <h3>Dungeon Progress</h3>
                <div id="dungeonStats" class="grid grid-3"></div>
            </div>
        </div>
        <!-- Summoning Screen -->
        <div id="summoning" class="screen">
            <button class="btn" onclick="showScreen('home')">üè† Home</button>
            <div class="header"><h1>üë• PARTY MANAGEMENT</h1></div>
            
            <div class="card">
                <h3>Captured Bosses</h3>
                <div id="bossGrid" class="grid grid-2"></div>
                <p style="text-align: center; color: #ffffff; margin-top: 15px;">
                    Capture bosses by defeating dungeon final bosses!<br>
                    Add up to 3 bosses to your party - they'll tank damage and attack with you!<br>
                    Success rate: 5% + INT * 2%
                </p>
            </div>
        </div>
        
        <div id="leaderboard" class="screen"><button class="btn" onclick="showScreen('home')">üè† Home</button><div class="header"><h1>üèÜ LEADERBOARD</h1></div><p>Leaderboard features coming soon...</p></div>
        
        <!-- Rewards Screen -->
        <div id="rewards" class="screen">
            <div class="header">
                <h1>üéâ REWARDS EARNED!</h1>
                <p>You've earned some fantastic rewards!</p>
            </div>
            
            <div id="rewardsContainer" class="settings-container">
                <!-- Rewards will be populated here -->
            </div>
            
            <button class="btn" id="claimRewardsBtn" onclick="claimDisplayedRewards()" style="width: 100%; padding: 20px; font-size: 1.2em; background: linear-gradient(45deg, #00ffff, #ffffff); color: #000000; margin-top: 20px;">üì¶ CLAIM REWARDS</button>
        </div>
        
        <!-- Chests Screen -->
        <div id="chests" class="screen">
            <button class="btn" onclick="showScreen('home')">üè† Home</button>
            <div class="header">
                <h1>üì¶ TREASURE CHESTS</h1>
                <p>Open chests to claim your rewards!</p>
            </div>
            
            <div id="chestsGrid" class="grid grid-2"></div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>üìä Chest Opening Times</h3>
                <div class="difficulty-info">
                    <p>üì¶ Wooden: 1 hour | üó≥Ô∏è Iron: 2 hours | üíº Silver: 4 hours</p>
                    <p>üéÅ Golden: 8 hours | üíé Platinum: 12 hours | üèÜ Legendary: 24 hours</p>
                </div>
            </div>
        </div>
        <!-- Settings Screen -->
        <div id="settings" class="screen">
            <div class="settings-nav">
                <button class="settings-nav-btn" onclick="showScreen('home')">home</button>
                <div class="settings-title">settings</div>
            </div>
            
            <div class="settings-container">
                <div class="settings-box">
                    <div class="settings-box-title">game settings</div>
                    <div class="settings-group">
                        <label class="setting-item">
                            <span>auto confirm workouts</span>
                            <input type="checkbox" id="autoConfirm" onchange="toggleSetting('autoConfirm')">
                        </label>
                        <label class="setting-item">
                            <span>sound effects</span>
                            <input type="checkbox" id="soundFX" checked onchange="toggleSetting('soundFX')">
                        </label>
                        <label class="setting-item">
                            <span>combat animations</span>
                            <input type="checkbox" id="animations" checked onchange="toggleSetting('animations')">
                        </label>
                    </div>
                </div>
                
                <div class="settings-box">
                    <div class="settings-box-title">workout difficulty</div>
                    <div class="settings-controls">
                        <select id="workoutDifficulty" onchange="changeDifficulty()" class="difficulty-select">
                            <option value="easy">easy</option>
                            <option value="normal" selected>normal</option>
                            <option value="hard">hard</option>
                        </select>
                        <div class="difficulty-info">
                            <span id="difficultyDesc">balanced workout intensity</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-box">
                    <div class="settings-box-title">fitness preferences</div>
                    <div class="settings-controls">
                        <button class="settings-btn" onclick="openPreferencesEditor()">edit preferences</button>
                        <div class="difficulty-info" style="margin-top: 10px;">
                            <span id="currentPrefsDisplay">current settings: loading...</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-box">
                    <div class="settings-box-title">preferences info</div>
                    <div class="settings-controls">
                        <div class="difficulty-info">
                            <p style="margin-bottom: 10px;">üéØ <strong>Daily Tasks:</strong> Automatically generated based on your workout split, gym level, and wellness goals.</p>
                            <p style="margin-bottom: 10px;">‚öîÔ∏è <strong>Dungeon Exercises:</strong> Discovery-based challenges that introduce new movements and variations.</p>
                            <p style="margin-bottom: 10px;">üìà <strong>Progression:</strong> Task difficulty scales with your experience level for optimal challenge.</p>
                            <p>üí° <strong>Tip:</strong> Update your preferences anytime to keep your fitness journey fresh and aligned with your goals!</p>
                        </div>
                    </div>
                </div>
                
                <div class="settings-box">
                    <div class="settings-box-title">game volume</div>
                    <div class="settings-controls">
                        <div class="volume-container">
                            <input type="range" id="gameVolume" min="0" max="100" value="50" onchange="changeVolume()" class="volume-range">
                            <span id="volumeDisplay">50%</span>
                        </div>
                        <div class="volume-presets">
                            <button class="preset-btn" onclick="setVolume(0)">mute</button>
                            <button class="preset-btn" onclick="setVolume(25)">low</button>
                            <button class="preset-btn" onclick="setVolume(75)">high</button>
                        </div>
                    </div>
                </div>
                
                <div class="settings-box tasks-box">
                    <div class="settings-box-title">daily tasks</div>
                    <div id="settingsTaskList" class="settings-tasks"></div>
                    <button id="settingsClaimBtn" class="settings-claim-btn" onclick="claimRewards()" style="display: none;">claim all rewards</button>
                </div>
            </div>
        </div>
        
        <!-- Mission Confirmation Modal -->
        <div id="missionModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-title">üöÄ Send Boss on Mission</div>
                
                <div class="mission-info">
                    <h3 id="modalBossName">Boss Name</h3>
                    <div class="mission-details">
                        <p><strong>Mission Duration:</strong> 5 seconds</p>
                        <p><strong>Expected Rewards:</strong></p>
                        <p>üèÜ XP: <span id="modalExpectedXP">150</span></p>
                        <p>üí∞ Coins: <span id="modalExpectedCoins">75</span></p>
                    </div>
                </div>
                
                <p style="color: #ffffff; margin-bottom: 20px;">
                    Are you sure you want to send this boss on a mission?
                </p>
                
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeMissionModal()">Cancel</button>
                    <button class="modal-btn confirm" onclick="confirmMission()">Send Mission</button>
                </div>
            </div>
        </div>
        
        <!-- In-Game Notification Container -->
        <div id="notificationContainer" class="notification-container"></div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentCombat = null;
        let currentSongIndex = 0;
        let isPlaying = false;
        let isShuffled = false;
        let isLooped = false;
        let playlist = [];

        // Utility functions
        const API_BASE = 'http://localhost:3000/api';
        
        // In-Game Notification System
        const showNotification = (message, type = 'info', duration = 3000) => {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                info: 'üíô',
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };
            
            notification.innerHTML = `
                <span class="notification-icon">${icons[type] || icons.info}</span>
                <span class="notification-text">${message}</span>
            `;
            
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, duration);
        };
        
        const request = async (url, options = {}) => {
            const response = await fetch(`${API_BASE}${url}`, {
                headers: { 'Content-Type': 'application/json' },
                ...options
            });
            return await response.json();
        };

        const showScreen = (screenName) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenName).classList.add('active');
            if (screenName === 'dungeons') loadDungeons();
            if (screenName === 'inventory') loadInventory();
            if (screenName === 'shop') loadShop();
            if (screenName === 'music') loadMusic();
            if (screenName === 'profile') loadProfile();
            if (screenName === 'settings') loadSettings();
            if (screenName === 'summoning') loadSummoning();
            if (screenName === 'chests') loadChests();
        };

        // Authentication
        const login = async () => {
            const nickname = document.getElementById('nickname').value.trim();
            if (!nickname) return showNotification('Please enter a nickname', 'warning');
            
            // Store nickname temporarily and show preferences screen
            window.tempNickname = nickname;
            showScreen('preferences');
            setupPreferencesDescriptions();
        };
        
        const setupPreferencesDescriptions = () => {
            const gymLevel = document.getElementById('gymLevelSetup');
            const gymLevelDesc = document.getElementById('gymLevelDesc');
            const splitDesc = document.getElementById('splitDesc');
            const restDaysCheckbox = document.getElementById('restDaysSetup');
            const restFrequency = document.getElementById('restFrequencySetup');
            const restDayOfWeek = document.getElementById('restDayOfWeekSetup');
            const restDayDesc = document.getElementById('restDayDesc');
            
            gymLevel.onchange = () => {
                const descriptions = {
                    beginner: 'gentle, beginner-friendly workouts',
                    intermediate: 'moderate intensity workouts',
                    advanced: 'challenging, high-intensity workouts'
                };
                gymLevelDesc.textContent = descriptions[gymLevel.value];
            };
            
            const updateRestDayDescription = () => {
                if (!restDaysCheckbox.checked) {
                    restDayDesc.textContent = 'no mandatory rest days';
                    return;
                }
                
                if (restFrequency.value === 'weekly') {
                    const day = restDayOfWeek.value;
                    restDayDesc.textContent = `${day} will be your weekly rest day`;
                } else {
                    restDayDesc.textContent = 'rest every other day automatically';
                }
            };
            
            restDaysCheckbox.onchange = updateRestDayDescription;
            restFrequency.onchange = () => {
                restDayOfWeek.style.display = restFrequency.value === 'weekly' ? 'block' : 'none';
                updateRestDayDescription();
            };
            restDayOfWeek.onchange = updateRestDayDescription;
            
            // Initial setup
            updateRestDayDescription();
        };
        
        const selectSetupSplit = (splitType) => {
            document.querySelectorAll('#preferences .split-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const descriptions = {
                'full-body': 'work entire body each session',
                'upper-lower': 'alternate upper and lower body days',
                'push-pull': 'separate push, pull, and leg movements'
            };
            
            document.getElementById('splitDesc').textContent = descriptions[splitType];
        };
        
        const savePreferencesAndStart = async () => {
            // Get selected workout split
            let selectedSplit = 'full-body';
            const activeSplitBtn = document.querySelector('#preferences .split-btn.active');
            if (activeSplitBtn) {
                const onclickStr = activeSplitBtn.getAttribute('onclick');
                if (onclickStr.includes('upper-lower')) selectedSplit = 'upper-lower';
                else if (onclickStr.includes('push-pull')) selectedSplit = 'push-pull';
            }
            
            const preferences = {
                workoutSplit: selectedSplit,
                gymLevel: document.getElementById('gymLevelSetup').value,
                preferredActivities: [
                    ...(document.getElementById('bodyweightSetup').checked ? ['bodyweight'] : []),
                    ...(document.getElementById('cardioSetup').checked ? ['cardio'] : []),
                    ...(document.getElementById('strengthSetup').checked ? ['strength'] : []),
                    ...(document.getElementById('flexibilitySetup').checked ? ['flexibility'] : [])
                ],
                dailyGoals: {
                    waterIntake: document.getElementById('waterSetup').checked,
                    steps: document.getElementById('stepsSetup').checked,
                    meditation: document.getElementById('meditationSetup').checked,
                    stretching: document.getElementById('stretchingSetup').checked
                },
                goals: [
                    ...(document.getElementById('generalFitnessSetup').checked ? ['general-fitness'] : []),
                    ...(document.getElementById('weightLossSetup').checked ? ['weight-loss'] : []),
                    ...(document.getElementById('muscleBuildingSetup').checked ? ['muscle-building'] : []),
                    ...(document.getElementById('enduranceSetup').checked ? ['endurance'] : [])
                ],
                restDays: {
                    enabled: document.getElementById('restDaysSetup').checked,
                    frequency: document.getElementById('restFrequencySetup').value,
                    dayOfWeek: document.getElementById('restDayOfWeekSetup').value
                }
            };
            
            currentUser = await request('/login', {
                method: 'POST',
                body: JSON.stringify({ nickname: window.tempNickname, preferences })
            });
            
            showScreen('home');
            updateUI();
            showNotification('Welcome! Your personalized fitness journey begins now! üöÄ', 'success', 4000);
        };
        
        const skipPreferences = async () => {
            currentUser = await request('/login', {
                method: 'POST',
                body: JSON.stringify({ nickname: window.tempNickname })
            });
            
            showScreen('home');
            updateUI();
            showNotification('You can set your preferences anytime in Settings ‚öôÔ∏è', 'info');
        };

        // UI Updates
        const updateUI = () => {
            if (!currentUser) return;
            
            document.getElementById('playerName').textContent = currentUser.nickname;
            document.getElementById('playerCoins').textContent = currentUser.coins;
            document.getElementById('playerLevel').textContent = currentUser.level;
            document.getElementById('playerHp').textContent = currentUser.hp;
            document.getElementById('playerMaxHp').textContent = currentUser.maxHp;
            document.getElementById('unspentPoints').textContent = currentUser.unspentPoints;
            
            // Update stats
            ['str', 'agi', 'vit', 'int', 'per'].forEach(stat => {
                document.getElementById(`${stat}Value`).textContent = currentUser.stats[stat];
            });
            
            
            // Update bars
            const xpProgress = (currentUser.xp / (currentUser.level * 100)) * 100;
            const hpProgress = (currentUser.hp / currentUser.maxHp) * 100;
            document.getElementById('xpFill').style.width = `${xpProgress}%`;
            document.getElementById('hpFill').style.width = `${hpProgress}%`;
            
            // Update tasks
            updateTasks();
            
            // Update boss grid
            updateBossGrid();
        };

        const updateTasks = () => {
            if (!currentUser || !currentUser.dailyTasks) return;
            
            const taskList = document.getElementById('taskList');
            const claimBtn = document.getElementById('claimBtn');
            
            if (!taskList) return;
            
            taskList.innerHTML = '';
            currentUser.dailyTasks.tasks.forEach((task, index) => {
                const completed = currentUser.dailyTasks.completed.includes(index);
                const taskDiv = document.createElement('div');
                taskDiv.className = `task ${completed ? 'completed' : ''}`;
                taskDiv.style.backgroundColor = '#2a2a2a';
                taskDiv.style.padding = '10px';
                taskDiv.style.margin = '5px 0';
                taskDiv.style.borderRadius = '5px';
                taskDiv.style.display = 'flex';
                taskDiv.style.justifyContent = 'space-between';
                taskDiv.style.alignItems = 'center';
                taskDiv.innerHTML = `
                    <span style="color: #00ffff; font-weight: bold;">${task}</span>
                    <button class="btn" onclick="completeTask(${index})" ${completed ? 'disabled' : ''}>
                        ${completed ? '‚úÖ' : '‚≠ï'}
                    </button>
                `;
                taskList.appendChild(taskDiv);
            });
            
            const allCompleted = currentUser.dailyTasks.completed.length === 5;
            const canClaim = allCompleted && (Date.now() - currentUser.dailyTasks.lastClaimed > 86400000);
            if (claimBtn) {
                claimBtn.style.display = canClaim ? 'block' : 'none';
            }
        };

        // Game actions
        const completeTask = async (taskIndex) => {
            try {
                const result = await request(`/user/${currentUser.id}/tasks/complete`, {
                    method: 'POST',
                    body: JSON.stringify({ taskIndex })
                });
                
                if (result.success) {
                    // Update completed tasks immediately
                    currentUser.dailyTasks.completed = result.completed;
                    updateUI();
                    showNotification('Task completed! ‚ú®', 'success', 2000);
                    
                    // Check if all tasks completed - show reward screen
                    if (currentUser.dailyTasks.completed.length === 5) {
                        setTimeout(() => showDailyTaskRewardScreen(), 1000);
                    }
                } else {
                    showNotification('Failed to complete task', 'error');
                }
            } catch (error) {
                console.error('Error completing task:', error);
                showNotification('Error completing task', 'error');
            }
        };

        const claimRewards = async () => {
            const result = await request(`/user/${currentUser.id}/tasks/claim`, { method: 'POST' });
            currentUser = result.user || result;
            updateUI();
            showNotification('Claimed 100 XP and 50 coins!', 'success');
        };

        const assignStat = async (stat) => {
            if (currentUser.unspentPoints <= 0) return;
            await request(`/user/${currentUser.id}/stats/assign`, {
                method: 'POST',
                body: JSON.stringify({ stat })
            });
            currentUser = await request(`/user/${currentUser.id}`);
            updateUI();
        };

        const heal = async () => {
            currentUser = await request(`/user/${currentUser.id}/heal`, { method: 'POST' });
            updateUI();
        };

        // Dungeons
        const loadDungeons = async () => {
            const data = await request(`/user/${currentUser.id}/dungeons`);
            const dungeonList = document.getElementById('dungeonList');
            
            dungeonList.innerHTML = '';
            ['E', 'D', 'C', 'B', 'A', 'S'].forEach(tier => {
                const available = data.available.includes(tier);
                const completedToday = data.progress.completedToday.includes(tier);
                const totalClears = data.progress.totalClears[tier] || 0;
                
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>Tier ${tier}</h3>
                    <p>Total Clears: ${totalClears}</p>
                    <p>${completedToday ? 'Completed Today' : 'First Clear Bonus Available'}</p>
                    <button class="btn" onclick="enterDungeon('${tier}')" ${!available ? 'disabled' : ''}>
                        ${available ? '‚öîÔ∏è ENTER' : 'üîí LOCKED'}
                    </button>
                `;
                dungeonList.appendChild(card);
            });
        };

        const enterDungeon = async (tier) => {
            currentCombat = await request(`/user/${currentUser.id}/dungeon/${tier}/enter`, { method: 'POST' });
            showScreen('combat');
            updateCombat();
            
            if (currentCombat.turn === 'enemy') {
                setTimeout(enemyTurn, 700);
            }
        };

        // Combat
        const updateCombat = () => {
            if (!currentCombat) return;
            
            document.getElementById('playerNameCombat').textContent = currentUser.nickname;
            document.getElementById('playerHpCombat').textContent = currentUser.hp;
            document.getElementById('playerMaxHpCombat').textContent = currentUser.maxHp || 100;
            document.getElementById('enemyNameCombat').textContent = currentCombat.enemy.name;
            document.getElementById('enemyHpCombat').textContent = currentCombat.enemy.hp;
            document.getElementById('enemyMaxHpCombat').textContent = currentCombat.enemy.maxHp;
            
            const isPlayerTurn = currentCombat.turn === 'player';
            document.getElementById('turnIndicator').textContent = isPlayerTurn ? 'Your Turn' : 'Enemy Turn';
            document.getElementById('turnIndicator').className = `turn-indicator ${isPlayerTurn ? 'turn-player' : 'turn-enemy'}`;
            
            document.getElementById('attackBtn').disabled = !isPlayerTurn || currentCombat.awaitingWorkout;
            document.getElementById('itemBtn').disabled = !isPlayerTurn || currentCombat.awaitingWorkout;
            document.getElementById('runBtn').disabled = !isPlayerTurn || currentCombat.awaitingWorkout;
            
            if (currentCombat.awaitingWorkout) {
                document.getElementById('workoutPrompt').style.display = 'block';
                document.getElementById('workoutText').textContent = currentCombat.workoutPrompt;
            } else {
                document.getElementById('workoutPrompt').style.display = 'none';
            }
        };

        const attack = async () => {
            // Immediately disable all combat buttons to prevent flash
            document.getElementById('attackBtn').disabled = true;
            document.getElementById('itemBtn').disabled = true;
            document.getElementById('runBtn').disabled = true;
            
            currentCombat = await request(`/user/${currentUser.id}/combat/attack`, { method: 'POST' });
            updateCombat();
        };

        const confirmWorkout = async () => {
            // Immediately disable all combat buttons to prevent flash
            document.getElementById('attackBtn').disabled = true;
            document.getElementById('itemBtn').disabled = true;
            document.getElementById('runBtn').disabled = true;
            
            const result = await request(`/user/${currentUser.id}/combat/confirm-workout`, { method: 'POST' });
            
            console.log('Confirm workout result:', result);
            
            // Handle boss victory that doesn't have showingDamage flag
            if (result.victory && !result.showingDamage) {
                console.log('Boss defeated without damage phase, creating damage sequence...');
                
                // Calculate damage dealt (enemy's remaining HP before defeat)
                let damageDealt = result.damageDealt;
                if (!damageDealt && currentCombat && currentCombat.enemy) {
                    damageDealt = currentCombat.enemy.hp; // This was the remaining HP before the final blow
                }
                
                // Set enemy HP to 0 for visual display
                if (currentCombat && currentCombat.enemy) {
                    currentCombat.enemy.hp = 0;
                }
                
                // Create a damage sequence for the boss defeat
                showDamageLog(damageDealt || 100); // fallback to 100 if no damage available
                updateCombat();
                
                // Ensure buttons stay disabled during damage sequence
                document.getElementById('attackBtn').disabled = true;
                document.getElementById('itemBtn').disabled = true;
                document.getElementById('runBtn').disabled = true;
                
                // Keep damage log visible during entire delay (900ms)
                setTimeout(() => {
                    hideDamageLog();
                    console.log('Boss delay complete, showing rewards screen');
                    // Show dungeon reward screen before capture screen
                    if (result.dungeonChest || result.scavengeChest) {
                        showDungeonRewardScreen(result);
                    } else {
                        showCaptureScreen(result);
                    }
                }, 900);
                return;
            }
            
            if (result.showingDamage) {
                console.log('Showing damage log with damage:', result.damageDealt);
                showDamageLog(result.damageDealt);
                currentCombat = result;
                updateCombat();
                
                // Ensure buttons stay disabled during damage sequence
                document.getElementById('attackBtn').disabled = true;
                document.getElementById('itemBtn').disabled = true;
                document.getElementById('runBtn').disabled = true;
                
                // Don't hide damage log here - let the next action hide it
                // Check if this was a boss victory after showing damage
                if (result.victory) {
                    setTimeout(() => {
                        hideDamageLog();
                        console.log('Boss delay complete, showing rewards screen');
                        // Show dungeon reward screen before capture screen
                        if (result.dungeonChest || result.scavengeChest) {
                            showDungeonRewardScreen(result);
                        } else {
                            showCaptureScreen(result);
                        }
                    }, 900);
                } else {
                    proceedAfterDamage(result);
                }
                return;
            }
            
            proceedAfterDamage(result);
        };

        const showDamageLog = (damage) => {
            console.log('showDamageLog called with damage:', damage);
            document.getElementById('damageLogAmount').textContent = damage;
            document.getElementById('damageLog').style.display = 'flex';
            console.log('Damage log display set to flex');
        };

        const hideDamageLog = () => {
            document.getElementById('damageLog').style.display = 'none';
        };

        const showPlayerDamageLog = (damage) => {
            console.log('showPlayerDamageLog called with damage:', damage);
            document.getElementById('playerDamageLogAmount').textContent = damage;
            document.getElementById('playerDamageLog').style.display = 'flex';
            console.log('Player damage log display set to flex');
        };

        const hidePlayerDamageLog = () => {
            document.getElementById('playerDamageLog').style.display = 'none';
        };

        const proceedAfterDamage = async (result) => {
            if (result.victory) {
                console.log('Boss victory detected, starting delay...');
                // Disable all combat buttons during boss defeat delay
                document.getElementById('attackBtn').disabled = true;
                document.getElementById('itemBtn').disabled = true;
                document.getElementById('runBtn').disabled = true;
                
                setTimeout(() => {
                    console.log('Boss delay complete, showing rewards screen');
                    // Show dungeon reward screen before capture screen
                    if (result.dungeonChest || result.scavengeChest) {
                        showDungeonRewardScreen(result);
                    } else {
                        showCaptureScreen(result);
                    }
                }, 900);
                return;
            }
            
            if (result.nextEnemy) {
                currentCombat = result.session;
                updateCombat();
                if (currentCombat.turn === 'enemy') {
                    setTimeout(() => {
                        hideDamageLog();
                        enemyTurn();
                    }, 700);
                } else {
                    hideDamageLog();
                }
                return;
            }
            
            if (result.enemyDefeated) {
                // Disable all combat buttons during enemy spawn delay
                document.getElementById('attackBtn').disabled = true;
                document.getElementById('itemBtn').disabled = true;
                document.getElementById('runBtn').disabled = true;
                
                setTimeout(async () => {
                    hideDamageLog();
                    const nextEnemy = await request(`/user/${currentUser.id}/combat/next-enemy`, { method: 'POST' });
                    if (nextEnemy.nextEnemy) {
                        currentCombat = nextEnemy.session;
                        updateCombat();
                    }
                }, 1000);
                return;
            }
            
            currentCombat = result;
            updateCombat();
            
            if (currentCombat.turn === 'enemy') {
                setTimeout(() => {
                    hideDamageLog();
                    enemyTurn();
                }, 700);
            } else {
                hideDamageLog();
            }
        };

        const cancelWorkout = async () => {
            currentCombat = await request(`/user/${currentUser.id}/combat/cancel`, { method: 'POST' });
            updateCombat();
        };

        const enemyTurn = async () => {
            const result = await request(`/user/${currentUser.id}/combat/enemy-turn`, { method: 'POST' });
            
            if (result.defeat) {
                // Show damage even on defeat
                if (result.playerDamage) {
                    showPlayerDamageLog(result.playerDamage);
                }
                setTimeout(async () => {
                    hidePlayerDamageLog();
                    showNotification('Defeat! You have been slain!', 'error');
                    currentUser = await request(`/user/${currentUser.id}`);
                    showScreen('home');
                }, 800);
                return;
            }
            
            currentCombat = result;
            currentUser = await request(`/user/${currentUser.id}`);
            
            // Show player damage if available
            if (result.playerDamage) {
                showPlayerDamageLog(result.playerDamage);
            }
            
            updateCombat();
            
            // Hide player damage log after delay and enable buttons for player turn
            setTimeout(() => {
                hidePlayerDamageLog();
            }, 700);
        };

        const showCombatItems = () => {
            if (!currentCombat || currentCombat.turn !== 'player') {
                showNotification('Not your turn!', 'warning');
                return;
            }
            
            loadCombatItems();
            showScreen('combatItems');
        };

        const loadCombatItems = () => {
            const grid = document.getElementById('combatItemGrid');
            grid.innerHTML = '';
            
            // Filter for combat-useful potions (heal and stat buffs)
            const combatItems = currentUser.inventory.items.filter(item => 
                item.category === 'potions' && 
                (item.effect === 'heal' || 
                 item.effect === 'buff_str' || 
                 item.effect === 'buff_agi' || 
                 item.effect === 'buff_vit' || 
                 item.effect === 'buff_all')
            );
            
            if (combatItems.length === 0) {
                grid.innerHTML = '<div class="card"><h3>No combat items available</h3><p>Find potions in shops or dungeon drops!</p></div>';
                return;
            }
            
            combatItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                const rarityClass = `rarity-${item.rarity || 'common'}`;
                
                let canUse = true;
                let disabledReason = '';
                
                if (item.effect === 'heal' && currentUser.hp >= currentUser.maxHp) {
                    canUse = false;
                    disabledReason = 'HP is full';
                }
                
                card.innerHTML = `
                    <h4 class="${rarityClass}">${item.name}</h4>
                    <p class="item-description">${item.description || 'No description'}</p>
                    <p class="item-stats">Effect: ${getEffectDescription(item)}</p>
                    <p>Rarity: <span class="${rarityClass}">${(item.rarity || 'common').charAt(0).toUpperCase() + (item.rarity || 'common').slice(1)}</span></p>
                    ${!canUse ? `<p style="color: #ff4444;">${disabledReason}</p>` : ''}
                    <button class="btn" onclick="useCombatItem('${item.id}')" ${!canUse ? 'disabled' : ''}>
                        Use Item
                    </button>
                `;
                grid.appendChild(card);
            });
        };

        const getEffectDescription = (item) => {
            switch (item.effect) {
                case 'heal': return `Restore ${item.value} HP`;
                case 'buff_str': return `+${item.value} STR for ${Math.floor(item.duration/60000)}min`;
                case 'buff_agi': return `+${item.value} AGI for ${Math.floor(item.duration/60000)}min`;
                case 'buff_vit': return `+${item.value} VIT for ${Math.floor(item.duration/60000)}min`;
                case 'buff_all': return `+${item.value} All Stats for ${Math.floor(item.duration/60000)}min`;
                default: return 'Unknown effect';
            }
        };

        const useCombatItem = async (itemId) => {
            const item = currentUser.inventory.items.find(i => i.id === itemId);
            if (!item) {
                showNotification('Item not found!', 'error');
                return;
            }
            
            const result = await request(`/user/${currentUser.id}/inventory/use/${itemId}`, { method: 'POST' });
            if (result.success) {
                currentUser = result.user;
                showNotification(`Used ${item.name}!`, 'success');
                
                // Go back to combat and end player turn
                showScreen('combat');
                updateCombat();
                setTimeout(enemyTurn, 1000);
            } else {
                showNotification('Cannot use this item right now', 'warning');
            }
        };
        const runAway = async () => { 
            // Collect any scavenged loot before leaving
            if (currentUser && currentUser.scavengedLoot && currentUser.scavengedLoot.length > 0) {
                await collectScavengedLoot();
            }
            showScreen('dungeons'); 
            currentCombat = null; 
        };

        let captureResultData = null;

        const showCaptureScreen = (result) => {
            captureResultData = result;
            
            // Set rewards
            document.getElementById('victoryXP').textContent = result.rewards.xp;
            document.getElementById('victoryCoins').textContent = result.rewards.coins;
            
            // Show item drops if any
            const itemDropsSection = document.getElementById('itemDropsSection');
            const itemDropsList = document.getElementById('itemDropsList');
            
            if (result.itemDrops && result.itemDrops.length > 0) {
                itemDropsList.innerHTML = '';
                result.itemDrops.forEach(item => {
                    const rarityClass = `rarity-${item.rarity || 'common'}`;
                    const dropDiv = document.createElement('div');
                    dropDiv.className = 'item-drop';
                    dropDiv.innerHTML = `
                        <h4 class="${rarityClass}">üì¶ ${item.name}</h4>
                        <p class="item-description">${item.description || 'No description'}</p>
                        <p class="item-stats">${formatItemStats(item.stats)}</p>
                        <p>Rarity: <span class="${rarityClass}">${(item.rarity || 'common').charAt(0).toUpperCase() + (item.rarity || 'common').slice(1)}</span></p>
                    `;
                    itemDropsList.appendChild(dropDiv);
                });
                itemDropsSection.style.display = 'block';
            } else {
                itemDropsSection.style.display = 'none';
            }
            
            // Calculate capture chance
            const stats = calculateClientStats(currentUser);
            const captureRate = Math.min(95, 5 + stats.int * 2);
            document.getElementById('captureChance').textContent = `${captureRate}%`;
            
            // Show the capture screen
            showScreen('capture');
            
            // Reset UI state
            document.getElementById('captureCircle').style.display = 'none';
            document.getElementById('captureResult').style.display = 'none';
            document.getElementById('captureCloseBtn').style.display = 'none';
            document.getElementById('captureControls').style.display = 'block';
        };

        const attemptCapture = () => {
            // Hide controls and show capture circle
            document.getElementById('captureControls').style.display = 'none';
            document.getElementById('captureCircle').style.display = 'flex';
            
            // Reset progress bar animation
            const progressBar = document.getElementById('captureProgress');
            progressBar.style.animation = 'none';
            progressBar.offsetHeight; // Trigger reflow
            progressBar.style.animation = null;
            
            // Show result after animation completes
            setTimeout(() => {
                // Hide capture circle
                document.getElementById('captureCircle').style.display = 'none';
                
                const captureResult = document.getElementById('captureResult');
                const captureResultText = document.getElementById('captureResultText');
                const captureResultDesc = document.getElementById('captureResultDesc');
                const captureCloseBtn = document.getElementById('captureCloseBtn');
                
                if (captureResultData.captured) {
                    captureResultText.textContent = 'üîÆ SUCCESS!';
                    captureResultText.className = '';
                    captureResultDesc.textContent = `Boss captured: ${captureResultData.boss.name}!`;
                } else {
                    captureResultText.textContent = '‚ùå FAILED!';
                    captureResultText.className = 'failed';
                    captureResultDesc.textContent = 'The boss escaped...';
                }
                
                captureResult.style.display = 'block';
                captureCloseBtn.style.display = 'block';
            }, 3000);
        };

        const calculateClientStats = (user) => {
            let totalStats = { str: user.stats.str, agi: user.stats.agi, vit: user.stats.vit, int: user.stats.int, per: user.stats.per };
            const equipped = user.inventory.equipped;
            [equipped.weapon, ...equipped.armor, ...equipped.accessories].forEach(item => {
                if (item) Object.keys(item.stats || {}).forEach(stat => totalStats[stat] += item.stats[stat]);
            });
            return totalStats;
        };

        const closeCaptureScreen = async () => {
            currentUser = await request(`/user/${currentUser.id}`);
            updateBossGrid();
            showScreen('dungeons');
        };

        // Inventory
        const loadInventory = () => {
            const equipped = currentUser.inventory.equipped;
            document.getElementById('weapon').textContent = equipped.weapon?.name || 'None';
            
            ['helmet', 'chest', 'legs', 'boots'].forEach((slot, i) => {
                document.getElementById(slot).textContent = equipped.armor[i]?.name || 'None';
            });
            
            ['ring1', 'ring2', 'necklace', 'bracelet'].forEach((slot, i) => {
                const element = document.getElementById(slot);
                if (slot === 'ring1') element.textContent = equipped.accessories[0]?.name || 'None';
                else if (slot === 'ring2') element.textContent = equipped.accessories[1]?.name || 'None';
                else if (slot === 'necklace') element.textContent = equipped.accessories[2]?.name || 'None';
                else element.textContent = equipped.accessories[3]?.name || 'None';
            });
            
            filterItems('all');
        };

        const formatItemStats = (stats) => {
            if (!stats) return 'No stat bonuses';
            const statNames = { str: 'STR', agi: 'AGI', vit: 'VIT', int: 'INT', per: 'PER' };
            const statArray = [];
            Object.entries(stats).forEach(([stat, value]) => {
                if (value > 0) {
                    statArray.push(`${statNames[stat] || stat.toUpperCase()}+${value}`);
                }
            });
            return statArray.length > 0 ? statArray.join(' ') : 'No stat bonuses';
        };

        const filterItems = (category) => {
            const grid = document.getElementById('itemGrid');
            grid.innerHTML = '';
            
            const filteredItems = category === 'all' ? 
                currentUser.inventory.items : 
                currentUser.inventory.items.filter(item => item.category === category);
            
            filteredItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                
                let actionButton = '';
                if (item.category === 'potions') {
                    actionButton = ''; // No button for potions in inventory
                } else {
                    actionButton = `<button class="btn" onclick="equipItem('${item.id}')">Equip</button>`;
                }
                
                const rarityClass = `rarity-${item.rarity || 'common'}`;
                
                card.innerHTML = `
                    <h4 class="${rarityClass}">${item.name}</h4>
                    <p class="item-description">${item.description || 'No description'}</p>
                    <p>Category: ${item.category}</p>
                    <p class="item-stats">${formatItemStats(item.stats)}</p>
                    <p>Rarity: <span class="${rarityClass}">${(item.rarity || 'common').charAt(0).toUpperCase() + (item.rarity || 'common').slice(1)}</span></p>
                    ${actionButton}
                `;
                grid.appendChild(card);
            });
        };

        const equipItem = async (itemId) => {
            await request(`/user/${currentUser.id}/inventory/equip/${itemId}`, { method: 'POST' });
            currentUser = await request(`/user/${currentUser.id}`);
            loadInventory();
        };

        const useItem = async (itemId) => {
            const result = await request(`/user/${currentUser.id}/inventory/use/${itemId}`, { method: 'POST' });
            if (result.success) {
                currentUser = result.user;
                updateUI();
                loadInventory();
                showNotification('Item used successfully!', 'success');
            } else {
                showNotification('Cannot use this item right now', 'warning');
            }
        };

        // Shop
        const loadShop = async () => {
            const shopData = await request(`/user/${currentUser.id}/shop`);
            const container = document.getElementById('shopItems');
            
            const categories = ['weapons', 'armor', 'accessories', 'potions'];
            container.innerHTML = '';
            
            categories.forEach(category => {
                const section = document.createElement('div');
                section.className = 'shop-section';
                section.innerHTML = `<h3>${category.toUpperCase()}</h3>`;
                
                const categoryItems = shopData.items.filter(item => item.category === category);
                categoryItems.forEach(item => {
                    const purchased = shopData.purchased.includes(item.id);
                    const card = document.createElement('div');
                    card.className = 'card';
                    const rarityClass = `rarity-${item.rarity || 'common'}`;
                    card.innerHTML = `
                        <h4 class="${rarityClass}">${item.name}</h4>
                        <p class="item-description">${item.description || 'No description'}</p>
                        <p>üí∞ ${item.price} coins</p>
                        <p class="item-stats">${formatItemStats(item.stats)}</p>
                        <p>Rarity: <span class="${rarityClass}">${(item.rarity || 'common').charAt(0).toUpperCase() + (item.rarity || 'common').slice(1)}</span></p>
                        <button class="btn" onclick="buyItem('${item.id}')" ${purchased || currentUser.coins < item.price ? 'disabled' : ''}>
                            ${purchased ? 'SOLD' : 'BUY'}
                        </button>
                    `;
                    section.appendChild(card);
                });
                
                container.appendChild(section);
            });
        };

        const buyItem = async (itemId) => {
            currentUser = await request(`/user/${currentUser.id}/shop/buy/${itemId}`, { method: 'POST' });
            updateUI();
            loadShop();
        };

        // Music
        const loadMusic = () => {
            playlist = currentUser.playlist || [];
            updateMusicUI();
        };

        const updateMusicUI = () => {
            const playlistDiv = document.getElementById('playlist');
            playlistDiv.innerHTML = '';
            
            playlist.forEach((song, index) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <p>${index + 1}. ${song.title} - ${song.artist}</p>
                    <button class="btn" onclick="playSong(${index})">‚ñ∂Ô∏è</button>
                `;
                playlistDiv.appendChild(div);
            });
            
            if (playlist.length > 0 && currentSongIndex < playlist.length) {
                const current = playlist[currentSongIndex];
                document.getElementById('currentSong').textContent = `${current.title} - ${current.artist}`;
            }
        };

        const addSong = async () => {
            const title = prompt('Song title:');
            const artist = prompt('Artist:');
            if (title && artist) {
                const song = { title, artist };
                await request(`/user/${currentUser.id}/music/add`, {
                    method: 'POST',
                    body: JSON.stringify({ song })
                });
                playlist.push(song);
                updateMusicUI();
            }
        };

        const deleteSong = async () => {
            if (playlist.length === 0) return;
            const index = parseInt(prompt(`Enter song number (1-${playlist.length}):`)) - 1;
            if (index >= 0 && index < playlist.length) {
                await request(`/user/${currentUser.id}/music/delete`, {
                    method: 'POST',
                    body: JSON.stringify({ index })
                });
                playlist.splice(index, 1);
                if (currentSongIndex >= playlist.length) currentSongIndex = 0;
                updateMusicUI();
            }
        };

        const toggleShuffle = () => {
            isShuffled = !isShuffled;
            document.getElementById('shuffleBtn').style.backgroundColor = isShuffled ? '#00ffff' : '';
        };

        const toggleLoop = () => {
            isLooped = !isLooped;
            document.getElementById('loopBtn').style.backgroundColor = isLooped ? '#00ffff' : '';
        };

        const togglePlay = () => {
            isPlaying = !isPlaying;
            document.getElementById('playBtn').textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
        };

        const playSong = (index) => {
            currentSongIndex = index;
            isPlaying = true;
            updateMusicUI();
            togglePlay();
        };

        const previousSong = () => {
            if (playlist.length === 0) return;
            currentSongIndex = isShuffled ? 
                Math.floor(Math.random() * playlist.length) : 
                (currentSongIndex - 1 + playlist.length) % playlist.length;
            updateMusicUI();
        };

        const nextSong = () => {
            if (playlist.length === 0) return;
            currentSongIndex = isShuffled ? 
                Math.floor(Math.random() * playlist.length) : 
                (currentSongIndex + 1) % playlist.length;
            updateMusicUI();
        };

        // Progress simulation
        setInterval(() => {
            if (isPlaying && playlist.length > 0) {
                const progress = Math.floor(Math.random() * 100);
                document.getElementById('progress').textContent = `${progress}%`;
                if (progress >= 99) {
                    if (isLooped) {
                        // Stay on same song
                    } else {
                        nextSong();
                    }
                }
            }
        }, 1000);

        // Profile functions
        const loadProfile = () => {
            if (!currentUser) return;
            
            document.getElementById('profileName').textContent = currentUser.nickname;
            document.getElementById('profileLevel').textContent = currentUser.level;
            document.getElementById('profileXP').textContent = currentUser.xp;
            document.getElementById('profileCoins').textContent = currentUser.coins;
            
            const totalDungeons = Object.values(currentUser.dungeonProgress.totalClears).reduce((a, b) => a + b, 0);
            document.getElementById('profileDungeons').textContent = totalDungeons;
            
            ['str', 'agi', 'vit', 'int', 'per'].forEach(stat => {
                document.getElementById(`profile${stat.charAt(0).toUpperCase() + stat.slice(1)}`).textContent = currentUser.stats[stat];
            });
            
            document.getElementById('friendCount').textContent = currentUser.friends.length;
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '';
            currentUser.friends.forEach(friend => {
                const div = document.createElement('div');
                div.innerHTML = `<p>üë§ ${friend}</p>`;
                friendsList.appendChild(div);
            });
            
            const dungeonStats = document.getElementById('dungeonStats');
            dungeonStats.innerHTML = '';
            Object.entries(currentUser.dungeonProgress.totalClears).forEach(([tier, count]) => {
                const div = document.createElement('div');
                div.innerHTML = `<strong>Tier ${tier}:</strong> ${count} clears`;
                dungeonStats.appendChild(div);
            });
        };

        const addFriend = async () => {
            const friendName = prompt('Enter friend\'s name:');
            if (friendName && friendName.trim()) {
                await request(`/user/${currentUser.id}/friends/add`, {
                    method: 'POST',
                    body: JSON.stringify({ friendName: friendName.trim() })
                });
                currentUser = await request(`/user/${currentUser.id}`);
                loadProfile();
            }
        };

        const removeFriend = async () => {
            if (currentUser.friends.length === 0) return showNotification('No friends to remove', 'warning');
            const friendName = prompt(`Enter friend name to remove:\n${currentUser.friends.join(', ')}`);
            if (friendName && currentUser.friends.includes(friendName)) {
                await request(`/user/${currentUser.id}/friends/remove`, {
                    method: 'POST',
                    body: JSON.stringify({ friendName })
                });
                currentUser = await request(`/user/${currentUser.id}`);
                loadProfile();
            }
        };

        // Settings functions
        const loadSettings = () => {
            updateSettingsTasks();
            updateCurrentPrefsDisplay();
        };

        const updateSettingsTasks = () => {
            if (!currentUser) return;
            
            const taskList = document.getElementById('settingsTaskList');
            const claimBtn = document.getElementById('settingsClaimBtn');
            
            taskList.innerHTML = '';
            currentUser.dailyTasks.tasks.forEach((task, index) => {
                const completed = currentUser.dailyTasks.completed.includes(index);
                const taskDiv = document.createElement('div');
                taskDiv.className = `settings-task ${completed ? 'completed' : ''}`;
                taskDiv.innerHTML = `
                    <span>${task}</span>
                    <button class="settings-task-btn" onclick="completeTask(${index})" ${completed ? 'disabled' : ''}>
                        ${completed ? '‚úÖ' : '‚≠ï'}
                    </button>
                `;
                taskList.appendChild(taskDiv);
            });
            
            const allCompleted = currentUser.dailyTasks.completed.length === 5;
            const canClaim = allCompleted && (Date.now() - currentUser.dailyTasks.lastClaimed > 86400000);
            claimBtn.style.display = canClaim ? 'block' : 'none';
        };

        const toggleSetting = (setting) => {
            const checkbox = document.getElementById(setting);
            localStorage.setItem(setting, checkbox.checked);
        };

        const changeDifficulty = () => {
            const difficulty = document.getElementById('workoutDifficulty').value;
            const descriptions = {
                easy: 'lighter workout intensity',
                normal: 'balanced workout intensity', 
                hard: 'challenging workout intensity'
            };
            document.getElementById('difficultyDesc').textContent = descriptions[difficulty];
            localStorage.setItem('workoutDifficulty', difficulty);
        };

        const openPreferencesEditor = async () => {
            if (!currentUser || !currentUser.preferences) {
                showNotification('Preferences not available', 'warning');
                return;
            }
            
            // Create a modal or new screen for editing preferences
            showNotification('Opening preferences editor...', 'info');
            
            // For now, show current preferences
            const prefs = currentUser.preferences;
            const prefsText = `
                Workout Split: ${prefs.workoutSplit}\n
                Gym Level: ${prefs.gymLevel}\n
                Activities: ${prefs.preferredActivities.join(', ')}\n
                Daily Goals: ${Object.entries(prefs.dailyGoals).filter(([k,v]) => v).map(([k,v]) => k).join(', ')}\n
                Fitness Goals: ${prefs.goals.join(', ')}
            `;
            alert('Current Preferences:' + prefsText + '\n\nFull preference editor coming soon!');
        };
        
        const updateCurrentPrefsDisplay = () => {
            if (!currentUser || !currentUser.preferences) {
                document.getElementById('currentPrefsDisplay').textContent = 'preferences not set';
                return;
            }
            
            const prefs = currentUser.preferences;
            const display = `${prefs.workoutSplit} split, ${prefs.gymLevel} level`;
            document.getElementById('currentPrefsDisplay').textContent = display;
        };

        const resetProgress = () => {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone!')) {
                localStorage.clear();
                location.reload();
            }
        };

        const exportData = () => {
            const data = JSON.stringify(currentUser, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentUser.nickname}_save.json`;
            a.click();
        };

        const importData = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            showNotification('Import feature coming soon!', 'info');
                        } catch (err) {
                            showNotification('Invalid save file!', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        };

        const createWorkoutSplit = () => {
            showNotification('Workout split creation coming soon!', 'info');
        };

        const changeVolume = () => {
            const volume = document.getElementById('gameVolume').value;
            document.getElementById('volumeDisplay').textContent = `${volume}%`;
            localStorage.setItem('gameVolume', volume);
        };

        const setVolume = (level) => {
            document.getElementById('gameVolume').value = level;
            document.getElementById('volumeDisplay').textContent = `${level}%`;
            localStorage.setItem('gameVolume', level);
        };

        // Summoning screen functions
        const loadSummoning = () => {
            updateBossGrid();
        };

        let selectedBossId = null;

        const addToParty = async (bossId) => {
            const boss = currentUser.capturedBosses.find(b => b.id === bossId);
            if (boss && currentUser.party.length < 3) {
                currentUser = await request(`/user/${currentUser.id}/boss/${bossId}/party/add`, { method: 'POST' });
                updateUI();
                updateBossGrid();
                showNotification(`${boss.name} added to party!`, 'success');
            }
        };

        const removeFromParty = async (bossId) => {
            const boss = currentUser.capturedBosses.find(b => b.id === bossId);
            if (boss) {
                currentUser = await request(`/user/${currentUser.id}/boss/${bossId}/party/remove`, { method: 'POST' });
                updateUI();
                updateBossGrid();
                showNotification(`${boss.name} removed from party!`, 'success');
            }
        };

        const updateBossGrid = () => {
            const bossGrid = document.getElementById('bossGrid');
            bossGrid.innerHTML = '';
            
            currentUser.capturedBosses.forEach(boss => {
                const bossCard = document.createElement('div');
                bossCard.className = 'card';
                
                const isInParty = currentUser.party.find(p => p.id === boss.id);
                const rarityClass = `rarity-${boss.tier}`;
                
                let partyInfo = '';
                if (isInParty) {
                    const partyMember = currentUser.party.find(p => p.id === boss.id);
                    partyInfo = `
                        <div style="background: #1a4a1a; padding: 10px; border-radius: 5px; margin: 10px 0; border: 2px solid #00ffff;">
                            <p style="color: #00ffff; font-weight: bold;">‚öîÔ∏è In Party</p>
                            <p>HP: ${partyMember.hp}/${partyMember.maxHp}</p>
                            <p>Attack: ${partyMember.attack}</p>
                            <p>Status: ${partyMember.isAlive ? '‚úÖ Alive' : 'üíÄ KO'}</p>
                        </div>
                    `;
                }
                
                bossCard.innerHTML = `
                    <h4 class="${rarityClass}">${boss.name}</h4>
                    <p>Tier <span class="${rarityClass}">${boss.tier}</span></p>
                    ${partyInfo}
                    <div style="margin: 10px 0;">
                        ${!isInParty && currentUser.party.length < 3 ? 
                            `<button class="btn" onclick="addToParty('${boss.id}')" style="background: #00ffff; color: #000000;">‚ûï Add to Party</button>` :
                            isInParty ? 
                            `<button class="btn" onclick="removeFromParty('${boss.id}')" style="background: #ff4444; color: #ffffff;">‚ûñ Remove from Party</button>` :
                            `<button class="btn" disabled style="opacity: 0.5;">Party Full (3/3)</button>`
                        }
                    </div>
                `;
                bossGrid.appendChild(bossCard);
            });
        };

        // Chest management functions
        const loadChests = async () => {
            const chestsData = await request(`/user/${currentUser.id}/chests`);
            const chestsGrid = document.getElementById('chestsGrid');
            
            chestsGrid.innerHTML = '';
            
            if (chestsData.chests.length === 0) {
                chestsGrid.innerHTML = '<div class="card" style="grid-column: 1 / -1;"><h3>No chests available</h3><p>Complete daily tasks and dungeons to earn chests!</p></div>';
                return;
            }
            
            chestsData.chests.forEach(chest => {
                const chestCard = document.createElement('div');
                chestCard.className = 'chest-card';
                
                const now = Date.now();
                const canOpen = chest.openTimeHours === 0 || !chest.isOpening || (chest.isOpening && (now - chest.startedOpening) >= (chest.openTimeHours * 60 * 60 * 1000));
                
                if (canOpen && chest.isOpening) {
                    chestCard.classList.add('ready');
                } else if (chest.isOpening) {
                    chestCard.classList.add('opening');
                }
                
                let timerText = '';
                if (chest.openTimeHours === 0) {
                    timerText = 'Ready to open!';
                } else if (chest.isOpening) {
                    const remainingTime = (chest.openTimeHours * 60 * 60 * 1000) - (now - chest.startedOpening);
                    if (remainingTime <= 0) {
                        timerText = 'Ready to open!';
                    } else {
                        const hours = Math.floor(remainingTime / (60 * 60 * 1000));
                        const minutes = Math.floor((remainingTime % (60 * 60 * 1000)) / (60 * 1000));
                        timerText = `${hours}h ${minutes}m remaining`;
                    }
                } else {
                    timerText = `${chest.openTimeHours}h to open`;
                }
                
                chestCard.innerHTML = `
                    <div class="chest-icon">${chest.icon}</div>
                    <h4 class="rarity-${chest.tier}">${chest.name}</h4>
                    <p>Source: ${chest.source}</p>
                    <div class="chest-timer">${timerText}</div>
                    <button class="btn" onclick="handleChest('${chest.id}')" ${!canOpen && chest.isOpening ? 'disabled' : ''}>
                        ${chest.openTimeHours === 0 ? 'Open Now' : chest.isOpening ? (canOpen ? 'Open!' : 'Opening...') : 'Start Opening'}
                    </button>
                `;
                
                chestsGrid.appendChild(chestCard);
            });
        };
        
        const handleChest = async (chestId) => {
            const chest = currentUser.chests.find(c => c.id === chestId);
            if (!chest) return;
            
            if (chest.openTimeHours === 0 || (chest.isOpening && Date.now() - chest.startedOpening >= chest.openTimeHours * 60 * 60 * 1000)) {
                // Open the chest
                const result = await request(`/user/${currentUser.id}/chest/${chestId}/open`, { method: 'POST' });
                if (result.success) {
                    currentUser = result.user;
                    updateUI();
                    showNotification(`Opened ${chest.name}! Got ${result.contents.coins} coins, ${result.contents.xp} XP, and ${result.contents.items.length} items!`, 'success', 4000);
                    loadChests();
                }
            } else if (!chest.isOpening) {
                // Start opening the chest
                const result = await request(`/user/${currentUser.id}/chest/${chestId}/start-opening`, { method: 'POST' });
                if (result.success) {
                    showNotification(`Started opening ${chest.name}. Come back in ${chest.openTimeHours} hour(s)!`, 'info');
                    loadChests();
                }
            }
        };
        
        // Reward screen functions
        let currentRewardData = null;
        
        const showDungeonRewardScreen = (result) => {
            currentRewardData = result;
            const container = document.getElementById('rewardsContainer');
            container.innerHTML = '';
            
            // Show dungeon chest
            if (result.dungeonChest) {
                const chestDiv = document.createElement('div');
                chestDiv.className = 'reward-item';
                chestDiv.innerHTML = `
                    <div class="reward-icon">${result.dungeonChest.icon}</div>
                    <h3 class="rarity-${result.dungeonChest.tier}">${result.dungeonChest.name}</h3>
                    <p>From: Dungeon Clear</p>
                    <p style="color: #00ff00;">Opens instantly!</p>
                `;
                container.appendChild(chestDiv);
            }
            
            // Show scavenge chest if any
            if (result.scavengeChest) {
                const chestDiv = document.createElement('div');
                chestDiv.className = 'reward-item';
                chestDiv.innerHTML = `
                    <div class="reward-icon">${result.scavengeChest.icon}</div>
                    <h3 class="rarity-${result.scavengeChest.tier}">${result.scavengeChest.name}</h3>
                    <p>From: Scavenged Loot</p>
                    <p style="color: #ffaa00;">Opens in ${result.scavengeChest.openTimeHours}h</p>
                `;
                container.appendChild(chestDiv);
            }
            
            // Show basic rewards
            const rewardsDiv = document.createElement('div');
            rewardsDiv.className = 'reward-item';
            rewardsDiv.innerHTML = `
                <div class="reward-icon">üéÜ</div>
                <h3>Dungeon Rewards</h3>
                <p>üí∞ ${result.rewards.coins} Coins</p>
                <p>‚≠ê ${result.rewards.xp} XP</p>
            `;
            container.appendChild(rewardsDiv);
            
            document.getElementById('claimRewardsBtn').onclick = () => claimDungeonRewards();
            showScreen('rewards');
        };
        
        const showDailyTaskRewardScreen = () => {
            const container = document.getElementById('rewardsContainer');
            container.innerHTML = '';
            
            const rewardsDiv = document.createElement('div');
            rewardsDiv.className = 'reward-item';
            rewardsDiv.innerHTML = `
                <div class="reward-icon">üéâ</div>
                <h3>All Daily Tasks Complete!</h3>
                <p>Great job finishing all your daily tasks!</p>
                <p>Claim your rewards to get a chest and bonuses!</p>
            `;
            container.appendChild(rewardsDiv);
            
            document.getElementById('claimRewardsBtn').onclick = () => claimDailyRewards();
            showScreen('rewards');
        };
        
        const claimDungeonRewards = () => {
            showNotification('Dungeon rewards claimed!', 'success');
            
            if (currentRewardData.captured !== undefined) {
                showCaptureScreen(currentRewardData);
            } else {
                showScreen('dungeons');
            }
        };
        
        const claimDailyRewards = async () => {
            const result = await request(`/user/${currentUser.id}/tasks/claim`, { method: 'POST' });
            currentUser = result.user || result;
            updateUI();
            showNotification('Daily task rewards claimed! You got a chest!', 'success');
            showScreen('home');
        };
        
        // Simple scavenge functions  
        const toggleScavenge = async () => {
            if (!currentCombat) {
                showNotification('No active combat session', 'warning');
                return;
            }
            
            const result = await request(`/user/${currentUser.id}/dungeon/${currentCombat.tier}/toggle-scavenge`, { method: 'POST' });
            currentCombat = result.session;
            
            const btn = document.getElementById('scavengeBtn');
            if (result.scavenging) {
                btn.textContent = 'üîç SCAVENGING';
                btn.style.background = '#00ff00';
                showNotification('Scavenging enabled!', 'success');
            } else {
                btn.textContent = 'üîç SCAVENGE';
                btn.style.background = '';
                showNotification('Scavenging disabled', 'info');
            }
        };
        
        const collectScavengedLoot = async () => {
            if (!currentUser.scavengedLoot || currentUser.scavengedLoot.length === 0) return;
            
            const result = await request(`/user/${currentUser.id}/scavenged-loot/collect`, { method: 'POST' });
            if (result.success) {
                currentUser = result.user;
                updateUI();
                showNotification(`Collected ${result.totalCoins} coins, ${result.totalXp} XP, and ${result.items.length} items!`, 'success');
            }
        };
        
        // Auto-refresh user data
        setInterval(async () => {
            if (currentUser) {
                currentUser = await request(`/user/${currentUser.id}`);
                updateUI();
                if (document.getElementById('settings').classList.contains('active')) {
                    updateSettingsTasks();
                }
                if (document.getElementById('summoning').classList.contains('active')) {
                    updateBossGrid();
                }
                if (document.getElementById('chests').classList.contains('active')) {
                    loadChests();
                }
            }
        }, 30000);

        // Update boss grid timers more frequently
        setInterval(() => {
            if (currentUser && document.getElementById('summoning').classList.contains('active')) {
                updateBossGrid();
            }
        }, 1000);
    </script>
</body>
</html>